<!DOCTYPE html>
<html>
  <head lang="en">
    <meta charset="UTF-8" />
    <title>TextHighlighter Demo | Serialization</title>
    <link
      href="http://fonts.googleapis.com/css?family=Open+Sans:700,400|Special+Elite"
      rel="stylesheet"
      type="text/css"
    />
    <link rel="stylesheet" type="text/css" href="assets/reset.css" />
    <link rel="stylesheet" type="text/css" href="assets/styles.css" />
    <link rel="stylesheet" type="text/css" href="assets/github.css" />
    <link rel="stylesheet" type="text/css" href="assets/ColorPicker.css" />

    <script type="text/javascript" src="assets/rainbow-custom.min.js"></script>

    <script type="text/javascript" src="assets/ColorPicker.js"></script>
    <script
      type="text/javascript"
      src="../build/dev/TextHighlighter.js"
    ></script>
  </head>
  <body>
    <div class="view">
      <div class="top" style="height: 400px;"></div>

      <div class="side">
        <h2>TextHighlighter Serialization</h2>
        <ul>
          <li>
            Select any text in the sandbox to highlight it.
          </li>
          <li>
            Change highlighting color:
            <div class="color-picker"></div>
          </li>
          <li>Remove all highlights: <button id="remove">Remove</button></li>
          <li>
            Serialize all highlights: <button id="serialize">Serialize</button>
          </li>
          <li>
            Deserialize highlights:
            <button id="deserialize">Deserialize</button>
          </li>
          <li>
            Focus highlight:
            <input
              type="text"
              id="focus-text-field"
              placeholder="Highlight ID"
            />
            <button id="focus">Focus</button>
          </li>
          <li>
            Deselect highlight:
            <input
              type="text"
              id="deselect-text-field"
              placeholder="Highlight ID"
            />
            <button id="deselect">Deselect</button>
          </li>
          <li>
            Remove highlight:
            <input
              type="text"
              id="remove-text-field"
              placeholder="Highlight ID"
            />
            <button id="removeHighlight">Remove Highlight</button>
          </li>
        </ul>
      </div>

      <div class="card shadow">
        <div id="stamp">SANDBOX</div>
        <div id="sandbox" class="content">
          <h1>Lorem ipsum</h1>
          <p>
            Lorem ipsum dolor sit amet, consectetur adipiscing elit. Donec
            luctus malesuada sagittis. Morbi purus odio, blandit ac urna sed,
            <b>interdum pharetra</b> leo. Cras congue id est sit amet mattis.
            Sed in metus et orci eleifend commodo. Phasellus at odio imperdiet,
            efficitur augue in, pulvinar sapien. Pellentesque leo nulla, porta
            non lectus eu, ullamcorper semper est. Nunc <i>convallis</i> risus
            vel mauris accumsan, in rutrum odio sodales. Vestibulum
            <b>ante ipsum</b> primis in faucibus orci luctus et ultrices posuere
            cubilia Curae; Sed at tempus mauris. Fusce blandit felis sit amet
            magna lacinia blandit.
          </p>
          <img class="shadow" src="assets/img.jpg" />
          <p>
            Maecenas faucibus hendrerit lectus, in auctor felis tristique at.
            Pellentesque a felis ut nibh malesuada auctor. Ut
            <b>egestas elit</b> ac ultrices ullamcorper. Pellentesque enim est,
            varius ultrices velit eget, consectetur aliquam tortor. Aliquam sit
            amet nibh id tellus sollicitudin faucibus. Nunc euismod augue
            tempus, ornare justo interdum, consectetur lacus. Pellentesque a
            molestie tellus, eget convallis lectus.
          </p>
          <p>
            Lorem ipsum dolor sit amet, consectetur adipiscing elit. Sed vitae
            nunc sed risus blandit convallis id id risus. Morbi tortor metus,
            imperdiet sed ipsum quis, condimentum mattis tellus. Fusce orci
            nisi, ultricies vel hendrerit id, egestas id turpis. Proin cursus
            diam tortor, sed ullamcorper eros commodo vitae. Aenean et maximus
            sapien. Nam felis velit, ullamcorper eu turpis ut, hendrerit
            accumsan augue. Nulla et purus sem. Ut at hendrerit purus.
            <b>Phasellus mollis commodo</b> ante eu mollis. In nec dui vel
            mauris lacinia vulputate id nec turpis. Aliquam vestibulum, elit sit
            amet fringilla malesuada, quam nunc eleifend nunc, id iaculis est
            neque pretium libero.
          </p>

          <table>
            <thead>
              <tr>
                <th>First Name</th>
                <th>Last Name</th>
                <th>Email</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>John</td>
                <td>Lucius</td>
                <td>j.lu@mail.com</td>
              </tr>
              <tr>
                <td>Nikolai</td>
                <td>Bodrov</td>
                <td>niko.b@mail.com</td>
              </tr>
              <tr>
                <td>Steve</td>
                <td>Suzy</td>
                <td>s.suzy@mail.com</td>
              </tr>
              <tr>
                <td>Alex</td>
                <td>Stirling</td>
                <td>alexs@mail.com</td>
              </tr>
            </tbody>
          </table>

          <p>
            Donec sollicitudin commodo risus in consequat. Curabitur ultricies
            sagittis mi, a dapibus nunc mollis sed. Sed ut pretium leo, quis
            vehicula diam. Proin nisi metus, elementum ut mi porttitor, cursus
            egestas sem. Interdum et malesuada fames ac ante ipsum primis in
            faucibus. Phasellus mattis ipsum ut enim efficitur mollis. Vivamus
            id mollis lectus.
          </p>

          <form action="#" method="post">
            <div>
              <label for="first-name">First name:</label>
              <input
                type="text"
                id="first-name"
                placeholder="Enter your first name"
              />
            </div>

            <div>
              <label for="last-name">Last name:</label>
              <input
                type="text"
                id="last-name"
                placeholder="Enter your last name"
              />
            </div>

            <div>
              <label for="gender">Gender:</label>
              <select id="gender">
                <option>Male</option>
                <option>Female</option>
              </select>
            </div>

            <input type="submit" disabled="true" value="Send" />
          </form>

          <p>
            In est tortor, tincidunt vitae elit at, ultricies tincidunt magna.
            Aenean suscipit ante sapien, quis sagittis felis efficitur feugiat.
            In arcu elit, hendrerit vel varius eget, elementum vitae lectus.
            Phasellus ut purus commodo ante iaculis molestie. Integer turpis
            felis, pellentesque eu dignissim vel, sodales vel metus. Aliquam
            tempus lorem odio. Sed purus arcu, auctor eget sodales ac, venenatis
            ac velit. Praesent a quam at purus varius accumsan sit amet quis
            magna. Praesent efficitur velit quis mi posuere, ut egestas elit
            egestas. Etiam vulputate lacus in posuere suscipit. Fusce molestie
            sem ipsum. Phasellus consectetur, purus quis auctor laoreet, elit
            nisi aliquet metus, et placerat nunc tellus ac massa. Praesent
            cursus ornare nulla eu ultrices.
          </p>
        </div>
      </div>
    </div>
    <div id="footer">
      Copyright &copy; 2019 by Perlego Limited. All Rights Reserved.
    </div>

    <script type="text/javascript">
      (function() {
        var highlightIds = [];

        var removeBtn = document.getElementById("remove"),
          serializeBtn = document.getElementById("serialize"),
          deserializeBtn = document.getElementById("deserialize");
        var focusBtn = document.getElementById("focus");
        var deselectBtn = document.getElementById("deselect");
        var removeHighlightBtn = document.getElementById("removeHighlight");
        var sandbox = document.getElementById("sandbox");
        var colors = new ColorPicker(document.querySelector(".color-picker"));
        window.hltr = new TextHighlighter(sandbox, {
          version: "independencia",
          preprocessDescriptors: function(range, descriptors) {
            var uniqueId = "hlt-" + Math.random()
              .toString(36)
              .substring(2, 15) +
              Math.random()
                .toString(36)
                .substring(2, 15);
            highlightIds.push(uniqueId);

            var descriptorsWithIds = descriptors.map(function(descriptor) {
              var wrapper = descriptor[0];
              var highlightedText = descriptor[1];
              var offset = descriptor[2];
              var length = descriptor[3];

              return [
                wrapper.replace(
                  'class="highlighted"',
                  "class=\"highlighted " + uniqueId + "\""
                ),
                highlightedText,
                offset,
                length
              ];
            });
            return { descriptors: descriptorsWithIds, meta: { id: uniqueId }};
          },
          onAfterHighlight: function(range, descriptors, timestamp, meta) {}
        });
        var serialized = {};

        colors.onColorChange(function(color) {
          hltr.setColor(color);
        });

        removeBtn.addEventListener("click", function() {
          hltr.removeHighlights();
          highlightIds = [];
        });

        focusBtn.addEventListener("click", function() {
          var highlightId = document.getElementById("focus-text-field").value;
          if (highlightId) {
            hltr.focusUsingId(highlightId.trim(), serialized[highlightId]);
          }
        });

        deselectBtn.addEventListener("click", function() {
          // Ensure all highlights are serialised first!
          highlightIds.forEach(function(highlightId) {
            serialized[highlightId] = hltr.serializeHighlights(highlightId);
          });

          var highlightId = document.getElementById("deselect-text-field")
            .value;
          if (highlightId) {
            var highlightDescriptors = Object.keys(serialized)
              .filter(function(currentHighlightId) { return currentHighlightId !== highlightId })
              .map(function(currentHighlightId) {
                return {
                  id: currentHighlightId,
                  serialisedDescriptor: serialized[currentHighlightId]
                };
              });
            hltr.deselectUsingId(highlightId.trim(), highlightDescriptors);
          }
        });

        serializeBtn.addEventListener("click", function() {
          highlightIds.forEach(function(highlightId) {
            serialized[highlightId] = hltr.serializeHighlights(highlightId);
          });
          hltr.removeHighlights();
        });

        deserializeBtn.addEventListener("click", function() {
          hltr.removeHighlights();
          highlightIds.forEach(function(highlightId) {
            hltr.deserializeHighlights(serialized[highlightId]);
          });
        });

        removeHighlightBtn.addEventListener("click", function() {
          // Ensure all highlights are serialised first!
          highlightIds.forEach(function(highlightId) {
            serialized[highlightId] = hltr.serializeHighlights(highlightId);
          });

          var highlightId = document.getElementById("remove-text-field")
            .value;
          if (highlightId) {
            hltr.removeHighlights(null,highlightId);
            highlightIds = highlightIds.filter((id) => id !== highlightId)
          }
        });

      })();
    </script>
  </body>
</html>
